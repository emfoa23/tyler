name: Deploy to EC2 via SSH Action

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types: [completed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
          
          echo "ğŸ“¦ GitHub Container Registry ë¡œê·¸ì¸ ì¤‘..."
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ… ë¡œê·¸ì¸ ì™„ë£Œ"
          
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
          docker stop tyler-app 2>/dev/null || true
          docker rm tyler-app 2>/dev/null || true
          echo "âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"
          
          echo "â¬‡ï¸ ìµœì‹  Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          docker pull ghcr.io/${{ github.repository }}:latest
          echo "âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          
          echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
          docker run -d \
            --name tyler-app \
            -p 80:80 \
            --restart unless-stopped \
            ghcr.io/${{ github.repository }}:latest
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          docker ps | grep tyler-app
          echo "âœ… ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì™„ë£Œ"
          
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

    - name: Health check
      run: |
        echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
        sleep 10
        echo "ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
        curl -f http://${{ secrets.EC2_HOST }} || exit 1
        echo "âœ… í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ - ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!" 